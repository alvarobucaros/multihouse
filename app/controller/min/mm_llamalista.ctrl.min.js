var app=angular.module("app",[]);app.controller("mainController",["$scope","$http",function(a,e){function o(o){var t=r();a.registro.lista_empresa=o,a.registro.codigo=t,a.registro.lista_id=0,e.post("modulos/mod_mm_llamalista.php?op=ri",{op:"ri",empresa:o,codigo:t}).success(function(e){a.details=e,a.configPages()}),e.post("modulos/mod_mm_llamalista.php?op=vl",{op:"vl",empresa:o,codigo:t}).success(function(e){a.registro.lista_id=e,a.numeroLlamado=e,a.nombreLlamado=s(e)})}function t(e){var o=a.nroAsisten,t=parseFloat(a.semaforo/100),s=parseFloat(a.porcQuorum),i=a.numeroLlamado;a.detalles=a.details[e];var l=parseFloat(a.detalles.lista_coeficiente),r="";"1"===i&&(r=a.detalles.lista_asiste1),"2"===i&&(r=a.detalles.lista_asiste2),"3"===i&&(r=a.detalles.lista_asiste3),"4"===i&&(r=a.detalles.lista_asiste4),"5"===i&&(r=a.detalles.lista_asiste5),"6"===i&&(r=a.detalles.lista_asiste6),"1"===r?(o+=1,t+=l):(o-=1,t-=l),a.nroAsisten=o,a.semaforo=100*t,a.color=t>s?"green":"red"}function s(e){return a.td1=!1,a.td2=!1,a.td3=!1,a.td4=!1,a.td5=!1,a.td6=!1,lista=["Todas","Primero","Segundo","Tercero","Cuarto","Quinto","Sexto"],"1"!==e&&"0"!==e||(a.td1=!0),"2"!==e&&"0"!==e||(a.td2=!0),"3"!==e&&"0"!==e||(a.td3=!0),"4"!==e&&"0"!==e||(a.td4=!0),"5"!==e&&"0"!==e||(a.td5=!0),"6"!==e&&"0"!==e||(a.td6=!0),lista[e]}function l(e){var o=parseFloat(a.porcQuorum);for(a.datos=[],a.datos=a.details,i=Math.ceil(a.details.length),coef=0,nr=0,ar=[],ll="lista_asiste"+e,x=0;x<i;x++)ar=a.datos[x],("1"===e&&"1"===ar.lista_asiste1||"2"===e&&"1"===ar.lista_asiste2)&&(coef+=parseFloat(a.datos[x].lista_coeficiente),nr+=1);return a.nroAsisten=nr,nr=100*coef,a.nroQuorum=nr.toFixed(2),coef>o?"smaforored":smaforogreen}function r(){var a=new Date,e=a.getDate(),o=a.getMonth()+1,t=a.getFullYear();return codigo=t.toString(),o<10&&(codigo+="0"),codigo+=o.toString(),e<10&&(codigo+="0"),codigo+=e.toString(),codigo}a.form_title="Asamblea o reunión - Llamado a lista",a.form_btnNuevo="Crear lista",a.form_btnGuarda="Guarda la lista",a.form_btnEdita="Edita",a.form_btnElimina="Elimina",a.form_btnAnula="Cerrar",a.form_btnExcel="Exporta Excel",a.form_btnActualiza="Actualizar",a.form_btnImprime="Imprime",a.form_titModal="Actualiza lista de registros",a.form_Phbusca="Consulta",a.form_selectLista="Cual Lista ?",a.form_lista_quorum="Quorum:",a.form_lista_asisten="Asisten:",a.form_lista_codigo="Fecha:",a.form_numeroLlamado="Llamado",a.verNueva=!0,a.td1=!1,a.td2=!1,a.td3=!1,a.td4=!1,a.td5=!1,a.td6=!1,a.nroAsisten=0,a.porcQuorum=50.5,a.semaforo=0,a.empresa=$("#e").val(),a.currentPage=0,a.pageSize=10,a.pages=[],a.registro=[],a.detalles=[],a.numeroLlamado=0,o(a.empresa),function(o){e.post("modulos/mod_mm_llamalista.php?op=0",{op:"0",empresa:o}).success(function(e){a.operators0=e})}(a.empresa),a.nueva=function(){var o=r(),t=$("#e").val();e.post("modulos/mod_mm_llamalista.php?op=rn",{op:"rn",empresa:t,codigo:o}).success(function(o){a.details=o,e.post("modulos/mod_mm_llamalista.php?op=0",{op:"0",empresa:t}).success(function(e){a.operators0=e}),a.configPages(),s(1)})},a.guarda=function(){for(a.datos=[],a.datos=a.details,i=Math.ceil(a.details.length),x=0;x<=i;x++)id=a.datos[x].lista_id,j1=a.datos[x].lista_asiste1,j2=a.datos[x].lista_asiste2,j3=a.datos[x].lista_asiste3,j4=a.datos[x].lista_asiste4,j5=a.datos[x].lista_asiste5,j6=a.datos[x].lista_asiste6,obs=a.datos[x].lista_obervacion,datos=id+"||"+j1+"||"+j2+"||"+j3+"||"+j4+"||"+j5+"||"+j6+"||"+obs,e.post("modulos/mod_mm_llamalista.php?op=a",{op:"a",datos:datos}).success(function(a){});alert("Lista guardada ")},a.selecCodigo=function(){empresa=$("#e").val(),lista=a.numeroLlamado,id=a.registro.lista_codigo,e.post("modulos/mod_mm_llamalista.php?op=dl",{op:"dl",id:id,lista:lista}).success(function(e){var o=e.split("||");a.registro.lista_id=o[0],a.numeroLlamado=o[1],a.nombreLlamado=s(o[1]),a.nroAsisten=0,a.registro.codigo=o[2],a.semaforo=l(1),o[1]>0&&(a.verNueva=!1)}),e.post("modulos/mod_mm_llamalista.php?op=ll",{op:"ll",id:id}).success(function(e){a.details=e,a.configPages()})},a.nuevaLista=function(){i=a.numeroLlamado,a.nombreLlamado=s(i),t(i),a.semaforo=l(i)},a.cuentaLista=function(a){t(a)},a.semaforo=function(){co=a.nroQuorum,q=parseFloat(a.porcQuorum),100*coef>q?a.semaforo="semaforored":a.semaforo="semaforogreen"},a.configPages=function(){a.pages.length=0;var e=a.currentPage-4,o=a.currentPage+5;e<1?(e=1,o=Math.ceil(a.details.length/a.pageSize)>10?10:Math.ceil(a.details.length/a.pageSize)):e>=Math.ceil(a.details.length/a.pageSize)-10&&(e=Math.ceil(a.details.length/a.pageSize)-10,o=Math.ceil(a.details.length/a.pageSize)),e<1&&(e=1);for(var t=e;t<=o;t++)a.pages.push({no:t});a.currentPage>=a.pages.length&&(a.currentPage=a.pages.length-1)},a.setPage=function(e){a.currentPage=e-1},a.formToggle=function(){$("#idForm").slideToggle(),a.lista_id=0,$("#idForm").css("display","none")},a.show_form=!0,a.formToggle=function(){$("#idForm").slideToggle(),a.formato.$setPristine(),a.registro=angular.copy(defaultForm)},a.editInfo=function(e){a.registro=e,$("#idForm").slideToggle()},a.exporta=function(){valor=confirm("Exporta la tabla de inmuebles y propietarios a Excel, continua?"),!0===valor&&(empresa=$("#e").val(),codigo=a.registro.codigo,e.post("modulos/mod_mm_llamalista.php?op=exp",{op:"exp",empresa:empresa,codigo:codigo}).success(function(a){$("#miExcel").html(a),alert("exporta a Excel. Cargue y renombre el documento... "),window.open("data:application/vnd.ms-excel,"+encodeURIComponent($("#miExcel").html()))}))},a.imprime=function(){empresa=a.empresa,codigo=a.registro.codigo,confirm("Va a imprimir el listado de asistencia con nombre\n c:/tmp/asistenciaAsamblea"+codigo+".pdf. \n Antes se debe crear la carpeta c:/tmp   Continua ?")&&(location.href="reports/rpt_mm_listas.php?co="+codigo+"&em="+empresa),empresa=a.empresa,codigo=a.registro.codigo,e.post("modulos/mod_mm_llamalista.php?op=imp",{op:"imp",empresa:empresa,codigo:codigo}).success(function(a){alert("Impresión concluída revise c:/tmp/asistenciaAsamblea"+codigo+".pdf")})},a.deleteInfo=function(a){confirm("Desea borrar el registro con nombre : "+a.lista_inmueble+" ?")&&e.post("modulos/mod_mm_llamalista.php?op=b",{op:"b",lista_id:a.lista_id}).success(function(a){"Ok"===a&&(o(),alert("Registro Borrado "))})},a.updateInfo=function(a){er="",""===$("#lista_id").val()&&(er+="falta id\n"),""===$("#lista_empresa").val()&&(er+="falta empresa\n"),""===$("#lista_codigo").val()&&(er+="falta codigo\n"),""===$("#lista_inmueble").val()&&(er+="falta inmueble\n"),""===$("#lista_asiste1").val()&&(er+="falta asiste1\n"),""===$("#lista_asiste2").val()&&(er+="falta asiste2\n"),""===$("#lista_asiste3").val()&&(er+="falta asiste3\n"),""===$("#lista_asiste4").val()&&(er+="falta asiste4\n"),""===$("#lista_asiste5").val()&&(er+="falta asiste5\n"),""===$("#lista_asiste6").val()&&(er+="falta asiste6\n"),""===$("#lista_area").val()&&(er+="falta area\n"),""===$("#lista_coeficiente").val()&&(er+="falta coeficiente\n"),""===$("#lista_propietario").val()&&(er+="falta propietario\n"),""===$("#lista_cedula").val()&&(er+="falta cedula\n"),""===$("#lista_obervacion").val()&&(er+="falta obervacion\n"),""===$("#lista_descripcion").val()&&(er+="falta descripcion\n"),""===er?e.post("modulos/mod_mm_llamalista.php?op=a",{op:"a",lista_id:a.lista_id,lista_empresa:a.lista_empresa,lista_codigo:a.lista_codigo,lista_inmueble:a.lista_inmueble,lista_asiste1:a.lista_asiste1,lista_asiste2:a.lista_asiste2,lista_asiste3:a.lista_asiste3,lista_asiste4:a.lista_asiste4,lista_asiste5:a.lista_asiste5,lista_asiste6:a.lista_asiste6,lista_area:a.lista_area,lista_coeficiente:a.lista_coeficiente,lista_propietario:a.lista_propietario,lista_cedula:a.lista_cedula,lista_obervacion:a.lista_obervacion,lista_descripcion:a.lista_descripcion}).success(function(a){"Ok"===a&&(o(),alert("Registro Actualizado "),$("#idForm").slideToggle())}):alert(er)},a.clearInfo=function(a){console.log("empty"),$("#idForm").slideToggle()}}]),app.filter("startFromGrid",function(){return function(a,e){return e=+e,a.slice(e)}});